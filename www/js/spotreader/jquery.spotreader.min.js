var is_spotreader_load=false;(function($){$.fn.spotreader=function(options){var defaults={load:null,mode:"",width:0,height:0,overlayopen:null,cover:""},setting=$.extend(defaults,options),showObj=$(this),showId=showObj.attr("id"),loadingObj=$("#loading"),isCover=false,itemImage={},scWidth=0,scHeight=0,caWidth=0,caHeight=0,boWidth=0,boHeight=0,fontStyles={fontSize:12,lineHeight:24,letterSpacing:2,fontFamily:SR_FONT_FAMILY},KINSOKU_BEGIN=SR_KINSOKU_BEGIN,KINSOKU_END=SR_KINSOKU_END,pages=[],pageNum=0,startReader=function(){var w,h,img_src;if(setting.cover!=""){var covQ=$("<img />").attr("src",setting.cover);covQ.attr("width",boWidth).attr("height",boHeight);pages.push($("<div />").append(covQ).html());pageNum++;isCover=true}$(setting.load+" > div").each(function(i){$(this).find("img").each(function(){var img=$(this);img_src=img.attr("src");w=img.attr("width");h=img.attr("height");itemImage[img_src]={width:w,height:h}});parsePage($(this).html(),false,true)});buildPages();showBooklet()},showBooklet=function(){var top_elm=$('<div class="b-load"></div>');top_elm.css("font-size",fontStyles.fontSize+"px");top_elm.css("line-height",fontStyles.lineHeight+"px");top_elm.css("letter-spacing",fontStyles.letterSpacing+"px");top_elm.css("font-family",fontStyles.fontFamily);for(var i=0;i<pages.length;i++)top_elm.append("<div>"+pages[i]+"</div>");var booklet_opts={speed:500,width:boWidth*2,height:boHeight,pagePadding:30,keyboard:true,pageNumbers:false};if(setting.mode!="inline"){booklet_opts.arrows=true,booklet_opts.prev="#spotreader-navi-prev";booklet_opts.next="#spotreader-navi-next";booklet_opts.first="#spotreader-navi-first";booklet_opts.last="#spotreader-navi-last";booklet_opts.overlays=false;booklet_opts.hash=true}if(setting.overlayopen)booklet_opts.overlayopen=setting.overlayopen;booklet_opts.hovers=false;booklet_opts.shadows=false;if(isCover){booklet_opts.closed=true;booklet_opts.covers=true;top_elm.append("<div></div>")}showObj.append(top_elm);showObj.booklet(booklet_opts);loadingObj.hide();pages=null;is_spotreader_load=false;showObj.addClass("book-center-bg")},convertParseHtml=function(html){if(html==null||html=="")return "";return html.replace(/(\n|\r|\t|\v)/mg,"").replace(/<br ?[^>]*>/img,"\n").replace(/<\/(p|div|li)>/img,"\n").replace(/<(p|div|ul|ol)[^>]*>/img,"").replace(/<(li|\/ul|\/ol)[^>]*>/img,"")},parsePage=function(section,cover,init){if(init)section=convertParseHtml(section);if(section==null||section=="")return "";var c="",nc="",nnc="",buf="",c_w=0,c_h=0,w_n=fontStyles.fontSize+fontStyles.letterSpacing,h_n=fontStyles.lineHeight,s_w=Math.floor(caWidth/w_n)-1,s_h=Math.floor(caHeight/h_n),ascii_w=(fontStyles.fontSize/2+fontStyles.letterSpacing)/w_n+.1,start=0,max=section.length,is_float=false,is_float_h=0,is_float_w=0;while(start<max){c=section.substr(start,1);if(c!=null){if(c=="<"){var tagStr=c,tagQ,tc="",tn=start+1,tm;while(true){tc=section.substr(tn,1);tagStr+=tc;if(tc==">"||tc==null){tm=tagStr.match(/^<img [^>]*src="([^"]+)"/i);if(tm&&tm[1]){var img_src=tm[1],max_w=cover?boWidth:caWidth,max_h=cover?boHeight:caHeight;if(itemImage[img_src]&&itemImage[img_src].width||cover){var i_w=itemImage[img_src].width,i_h=itemImage[img_src].height;if(cover){i_h=max_h;i_w=max_w}else if(i_w>max_w){i_h=i_h*(max_w/i_w);i_w=max_w}tagQ=$(tagStr).css({width:i_w,height:i_h,"margin-bottom":5});tagStr=$("<div />").html(tagQ).html();if(tagQ.css("float")!=""&&tagQ.css("float")!="none"){is_float=true;float_w=s_w-Math.floor(i_w/w_n)-1;float_h=Math.floor(i_h/h_n)+c_h}else{var nokori=caHeight-c_h*h_n;if(nokori<i_h){c_w=0;c_h=0;buf=strim(buf);if(buf!=""){pages.push(buf);pageNum++;buf="";is_float=false}}else c_h+=Math.floor(i_h/h_n)}}else{var h_size=5;tagQ=$(tagStr).css({"max-width":max_w,"max-height":h_n*h_size,"margin-bottom":5});tagStr=$("<div />").html(tagQ).html();if(tagQ.css("float")!=""){h_size=2;c_w+=s_w/2}c_h+=h_size}buf+=tagStr}else if(tagStr.match(/^<a /i)){tagStr+=tagStr.replace(/ href="([^"]+)"/i,' href="$1" target="_blank"');buf+=tagStr}else if(tagStr.match(/<\/h[1-6]{1}>/i)){buf+=tagStr;c_w=0;c_h+=1}else buf+=tagStr;start=tn;break}tn++}start++;continue}if(c!="\n")if(c=="")c_w+=0;else if(isAscii(c))c_w+=ascii_w;else c_w+=1;if((is_float?c_w>=float_w:c_w>=s_w)||c=="\n"){nc=section.substr(start+1,1)||"";nnc=section.substr(start+2,1)||"";if(KINSOKU_BEGIN.indexOf(nc,0)>-1&&KINSOKU_BEGIN.indexOf(nnc,0)==-1){if(c=="\n")c=nc;else c+=nc;c+="\n";start++}else if(c!="\n")c+="\n";c_w=0;c_h+=1}buf+=c;if(is_float&&c_h>float_h){is_float=false;float_w=0;float_h=0}if(c_h>=s_h){c_w=0;c_h=0;buf=strim(buf);if(buf!=""){pages.push(buf.replace(/\n/mg,"<br />"));buf="";pageNum++;is_float=false}}}start++}buf=strim(buf);if(buf!=""){pages.push(buf.replace(/\n/mg,"<br />"));buf="";pageNum++;is_float=false}return section},buildPages=function(){for(var start=setting.cover==""?0:1,max=pages.length,i=start;i<max;i++)if(i>start){var bTag=rebuildPrev(pages[i-1]);pages[i]=bTag+pages[i]}for(var i=start;i<max;i++){var eTag=rebuildNext(pages[i]);pages[i]=pages[i]+eTag}},rebuildPrev=function(html){for(var len=html.length-1,c="",buf=[],arr=[],tags=[],i=len;i>=0;i--){c=html.substr(i,1);if(c==">"){buf=[];buf.push(c);while(i>=0){c=html.substr(--i,1);buf.push(c);if(c=="<"){buf.reverse();var tag=buf.join("").toLowerCase();if(tag.substr(0,3)=="<br"||tag.substr(0,4)=="<img")break;if(tag.substr(0,2)=="</")arr.push(tag.substr(2,tag.length-3));else{var m=tag.match(/^<([^> ]+)/);if(m)if(arr[arr.length-1]==m[1])arr.pop();else tags.push(tag)}break}}}}tags.reverse();return tags.join("")},rebuildNext=function(html){for(var len=html.length,c="",buf=[],arr=[],tags=[],i=0;i<len;i++){c=html.substr(i,1);if(c=="<"){buf=[];buf.push(c);while(i<len){c=html.substr(++i,1);buf.push(c);if(c==">"){var tag=buf.join("").toLowerCase();if(tag.substr(0,3)=="<br"||tag.substr(0,4)=="<!--"||tag.substr(0,4)=="<img")break;if(tag.substr(0,2)=="</")if(arr[arr.length-1]==tag.substr(2,tag.length-3))arr.pop();else tags.push(tag);else{var m=tag.match(/^<([^> ]+)/);m&&arr.push(m[1])}break}}}}if(arr.length>0)for(var i=arr.length-1;i>=0;i--)tags.push("</"+arr[i]+">");return tags.join("")},init=function(){is_spotreader_load=true;pages=[];pageNum=0;var loading;if(setting.mode=="inline"){scWidth=setting.width;boWidth=scWidth/2;boHeight=boWidth/.75;scHeight=boHeight;caHeight=boHeight-65;caWidth=boWidth-65}else{scHeight=$(window).height();scWidth=$(window).width();boHeight=scHeight-100;boWidth=boHeight*.75;caHeight=boHeight-70;caWidth=boWidth-70;loading=$("<img />").attr("src","/js/spotreader/images/loading.gif");loadingObj=$('<div id="loading"><div>'+SR_NOW_LOADING+"</div></div>");loadingObj.css({position:"absolute",top:(scHeight-19)/2,left:(scWidth-220)/2,color:"#666","text-align":"center"});$("#spotreader-navi-big").click(function(e){e.preventDefault();fontStyles.fontSize+=2;fontStyles.lineHeight=fontStyles.fontSize*2;resetReader()});$("#spotreader-navi-small").click(function(e){e.preventDefault();fontStyles.fontSize-=2;fontStyles.lineHeight=fontStyles.fontSize*2;resetReader()});loadingObj.prepend(loading);showObj.append(loadingObj)}showObj.height(scHeight);showObj.width(scWidth)},resetReader=function(){is_spotreader_load=true;showObj.booklet("clearpollhash");showObj.empty();showObj.removeClass("booklet book-center-bg");showObj.append(loadingObj);loadingObj.show();pages=[];pageNum=0;$.fn.booklet.interfaces=[];startReader()},exitMsg=function(msg){epub=null;alert(msg);return false},isAscii=function(s){var c=s.charCodeAt(0);if(c>=0&&c<129||c==63728||c>=65377&&c<65440||c>=63729&&c<63732)return true;return false},strim=function(str){return str.replace(/^[ \r\n]+/,"").replace(/[ \r\n]+$/,"")},debug=function(obj){var str="";if(typeof obj==="object")for(var i in obj)str+=i+" => "+debug(obj[i]);else str+=obj+"\n";return str};if(is_spotreader_load==false){init();startReader()}return this}})(jQuery)